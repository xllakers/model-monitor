<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Monitor</title>
  <style>
    /* Tokyo Night inspired geek theme - easy on eyes, dark mode exclusively */
    :root {
      --bg: #1a1b26;
      --card-bg: #24283b;
      --text-main: #c0caf5;
      --text-secondary: #9aa5ce;
      --text-tertiary: #565f89;
      --accent: #7aa2f7;
      --accent-hover: #8caaee;
      --border: #414868;
      --border-hover: #565f89;
      --tab-bg: #1f2335;
      --tab-active: #292e42;
      --badge-yellow-bg: rgba(224, 175, 104, 0.15);
      --badge-yellow-text: #e0af68;
      --badge-green-bg: rgba(158, 206, 106, 0.15);
      --badge-green-text: #9ece6a;
      --glass-bg: rgba(26, 27, 38, 0.85);
      --glass-border: rgba(122, 162, 247, 0.2);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
      --shadow-glass: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      
      /* Red for negative drops */
      --text-red: #f7768e;
      --bg-red: rgba(247, 118, 142, 0.15);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }

    /* Floating Navigation Pill */
    header {
      position: sticky;
      top: 24px;
      z-index: 1000;
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
    }

    .nav-pill {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 10px 24px;
      border-radius: 9999px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-glass);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .nav-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.3);
      border-color: rgba(122, 162, 247, 0.4);
    }

    .nav-pill h1 { 
      font-size: 15px; 
      font-weight: 700; 
      letter-spacing: -0.01em;
      color: var(--accent);
    }
    
    .nav-meta { 
      font-size: 12px; 
      color: var(--text-secondary); 
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Main Layout */
    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 0 24px 100px;
      display: flex;
      flex-direction: column;
      gap: 64px;
    }

    section {
      display: flex;
      flex-direction: column;
    }

    details {
      width: 100%;
    }
    
    details > summary {
      list-style: none;
      cursor: pointer;
      outline: none;
    }
    
    details > summary::-webkit-details-marker {
      display: none;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 4px;
      margin-bottom: 20px;
      user-select: none;
    }

    section h2 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.2s;
    }
    
    section summary:hover h2 {
      color: var(--accent-hover);
    }
    
    .fold-icon {
      display: inline-block;
      font-size: 10px;
      color: var(--accent);
      transition: transform 0.2s ease;
      margin-right: 4px;
    }
    
    details:not([open]) .fold-icon {
      transform: rotate(-90deg);
    }
    
    section h2::before {
      content: '';
      display: block;
      width: 4px;
      height: 18px;
      background: var(--accent);
      border-radius: 2px;
    }

    .section-content {
      animation: fadeIn 0.3s ease;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: border-color 0.2s ease;
    }
    
    .card:hover {
      border-color: var(--border-hover);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 800px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Wide tables get a min-width so columns don't squish; scroll instead */
    table.scorecard-table {
      min-width: 860px;
    }
    table.scorecard-table th,
    table.scorecard-table td {
      white-space: nowrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      text-align: left;
    }

    th {
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      border-bottom: 1px solid var(--border);
      background: var(--tab-bg);
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease, background 0.2s ease;
    }

    th:hover { 
      color: var(--text-main);
      background: var(--border); 
    }

    th.active-sort { 
      color: var(--accent); 
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      color: var(--text-secondary);
      transition: background 0.15s ease;
    }

    tr:last-child td { border-bottom: none; }
    
    tr:hover td { 
      background: var(--tab-bg); 
      color: var(--text-main);
    }
    
    tr:hover .col-model {
      color: var(--text-main);
    }

    /* Columns Specifics */
    .col-rank { text-align: center; }
    .col-model { 
      font-weight: 500; 
      color: var(--text-main);
    }
    .col-val { 
      font-variant-numeric: tabular-nums; 
    }
    .col-delta { 
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    /* Badges & Indicators */
    .rank-num {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-tertiary);
    }
    
    .top3 .rank-num { 
      color: var(--badge-yellow-text);
      font-weight: 700;
    }

    .tag {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      letter-spacing: 0.02em;
      vertical-align: middle;
    }
    
    .tag-new { 
      background: var(--badge-yellow-bg); 
      color: var(--badge-yellow-text); 
    }
    
    .tag-rise { 
      background: var(--badge-green-bg); 
      color: var(--badge-green-text); 
    }

    .cat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Tabs */
    .tabs {
      background: var(--tab-bg);
      padding: 4px;
      border-radius: 8px;
      display: inline-flex;
      border: 1px solid var(--border);
    }

    .tab {
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab:hover {
      color: var(--text-main);
    }

    .tab.active {
      background: var(--tab-active);
      color: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadeIn 0.4s ease; }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(4px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }

    .btn-page {
      font-size: 13px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      background: var(--tab-bg);
      border: 1px solid transparent;
    }
    
    .btn-page:hover:not(.disabled):not(.active) { 
      border-color: var(--border);
      color: var(--text-main);
    }
    
    .btn-page.active { 
      background: var(--accent); 
      color: var(--bg); 
      border-color: var(--accent);
    }
    
    .btn-page.disabled { 
      opacity: 0.3; 
      pointer-events: none; 
    }

    /* Utilities */
    .na { color: var(--text-tertiary); font-weight: 400; }
    .text-green { color: var(--badge-green-text); }
    .text-red { color: var(--text-red); }
    
    .sort-icon {
      font-size: 10px;
      margin-left: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
      display: inline-block;
      transform: translateY(-1px);
    }
    
    th:hover .sort-icon { opacity: 0.5; }
    .active-sort .sort-icon { opacity: 1; }
    
    /* Decision-support sections */
    .picks-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 700px) {
      .picks-grid { grid-template-columns: 1fr; }
    }

    .picks-grid .card-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
      padding: 12px 16px 8px;
      border-bottom: 1px solid var(--border);
    }

    .score-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(158, 206, 106, 0.15);
      color: var(--badge-green-text);
    }

    .btn-refresh {
      font-size: 12px;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--tab-bg);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-refresh:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-refresh:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .insights-body {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-secondary);
      padding: 24px;
    }

    .insights-body h1, .insights-body h2, .insights-body h3 {
      color: var(--text-main);
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    
    .insights-body h1:first-child, .insights-body h2:first-child, .insights-body h3:first-child {
      margin-top: 0;
    }

    .insights-body p {
      margin-bottom: 1em;
    }
    
    .insights-body p:last-child {
      margin-bottom: 0;
    }

    .insights-body ul, .insights-body ol {
      margin-bottom: 1em;
      padding-left: 24px;
    }

    .insights-body li {
      margin-bottom: 0.5em;
    }

    .insights-body strong, .insights-body b {
      color: var(--text-main);
      font-weight: 600;
    }
    
    .insights-body a {
      color: var(--accent);
      text-decoration: none;
    }

    .insights-body a:hover {
      text-decoration: underline;
    }
    
    .insights-body hr {
      border: 0;
      border-top: 1px solid var(--border);
      margin: 1.5em 0;
    }

    .insights-placeholder {
      color: var(--text-tertiary);
      font-size: 13px;
      padding: 32px 20px;
      text-align: center;
    }

    /* Lab avatars */
    .lab-avatar-container {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      position: relative;
      vertical-align: middle;
    }
    .lab-logo {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      object-fit: contain;
      background: #fff;
      padding: 2px;
    }
    .lab-avatar {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 800;
      color: #fff;
      background: var(--border);
      flex-shrink: 0;
      letter-spacing: 0;
    }
    .col-avatar {
      width: 36px;
      text-align: center;
      padding-right: 4px;
    }

    /* Elegant scrollbar for Tokyo Night */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
      border: 2px solid var(--bg);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<header>
  <div class="nav-pill">
    <h1>LLM Monitor</h1>
    <div class="nav-meta">{{ last_updated }}</div>
  </div>
</header>

<main>

  <!-- AI Insights -->
  <section id="ai-insights">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> AI Insights</h2>
        <button class="btn-refresh" id="insights-btn" onclick="refreshInsights(event)">Refresh</button>
      </summary>
      <div class="section-content">
        <div class="card" id="insights-card">
          <div class="insights-placeholder" id="insights-text">
            {% if ai_insights %}
            Loading analysis...
            {% else %}
            No analysis cached ‚Äî click Refresh to generate
            {% endif %}
          </div>
          {% if ai_insights %}
          <script type="application/json" id="initial-insights-data">
            {{ ai_insights|tojson|safe }}
          </script>
          {% endif %}
        </div>
      </div>
    </details>
  </section>

  <!-- Fast Risers -->
  <section id="fast-risers">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> Fast Risers</h2>
        <div style="display:flex; gap:12px; align-items:center;" onclick="event.preventDefault(); event.stopPropagation();">
          <div class="tabs" id="fr-win">
            <button class="tab active" data-win="7d" onclick="switchFrWin('7d')">7d</button>
            <button class="tab" data-win="30d" onclick="switchFrWin('30d')">30d</button>
          </div>
          <div class="tabs">
            <button class="tab {% if tab == 'general' %}active{% endif %}" data-cat="general" onclick="switchTab('general')">General</button>
            <button class="tab {% if tab == 'coding' %}active{% endif %}" data-cat="coding" onclick="switchTab('coding')">Coding</button>
          </div>
        </div>
      </summary>
      <div class="section-content">
        <div class="card">
          {% for win in ["7d", "30d"] %}{% for cat_key in ["general", "coding"] %}
          <div class="tab-panel {% if win == '7d' and tab == cat_key %}active{% endif %}" data-section="fr" data-cat="{{ cat_key }}" data-win="{{ win }}">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="col-rank">#</th>
                    <th class="col-avatar"></th>
                    <th class="{% if sort_fr_by == 'rank' %}active-sort{% endif %}" onclick="applySort('rank', 'fr')">
                      Model <span class="sort-icon">{{ '‚Üì' if (sort_fr_by == 'rank' and sort_fr_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-delta {% if sort_fr_by == 'delta' %}active-sort{% endif %}" onclick="applySort('delta', 'fr')">
                      Change <span class="sort-icon">{{ '‚Üì' if (sort_fr_by == 'delta' and sort_fr_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_fr_by == 'elo' %}active-sort{% endif %}" onclick="applySort('elo', 'fr')">
                      ELO <span class="sort-icon">{{ '‚Üì' if (sort_fr_by == 'elo' and sort_fr_order == 'desc') else '‚Üë' }}</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in fast_risers[win][cat_key] %}
                  <tr class="{% if r.rank <= 3 %}top3{% endif %}">
                    <td class="col-rank"><span class="rank-num">{{ r.rank }}</span></td>
                    <td class="col-avatar">
                      <div class="lab-avatar-container">
                        {% if r.lab_logo %}
                          <img src="{{ r.lab_logo }}" class="lab-logo" alt="{{ r.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <span class="lab-avatar" data-lab="{{ r.lab }}" {% if r.lab_logo %}style="display:none;"{% endif %}>{{ r.lab[0] }}</span>
                      </div>
                    </td>
                    <td class="col-model" title="{{ r.model_display }}">{{ r.model_display }}</td>
                    <td class="col-delta text-green">‚Üë{{ r.rank_delta }}</td>
                    <td class="col-val">{{ r.elo }}</td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-tertiary); padding: 32px 0;">No significant risers yet</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}{% endfor %}
        </div>
      </div>
    </details>
  </section>

  <!-- New Stars -->
  <section id="new-stars">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> New Stars</h2>
        <div class="tabs" id="ns-win" onclick="event.preventDefault(); event.stopPropagation();">
          <button class="tab active" data-win="7d" onclick="switchNsWin('7d')">7d</button>
          <button class="tab" data-win="30d" onclick="switchNsWin('30d')">30d</button>
        </div>
      </summary>
      <div class="section-content">
        <div class="card">
          {% for win in ["7d", "30d"] %}
          <div class="tab-panel {% if win == '7d' %}active{% endif %}" data-section="ns" data-win="{{ win }}">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width: 80px">Category</th>
                    <th class="col-rank">Rank</th>
                    <th class="col-avatar"></th>
                    <th class="{% if sort_ns_by == 'rank' %}active-sort{% endif %}" onclick="applySort('rank', 'ns')">
                      Model <span class="sort-icon">{{ '‚Üì' if (sort_ns_by == 'rank' and sort_ns_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_ns_by == 'elo' %}active-sort{% endif %}" onclick="applySort('elo', 'ns')">
                      ELO <span class="sort-icon">{{ '‚Üì' if (sort_ns_by == 'elo' and sort_ns_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_ns_by == 'price' %}active-sort{% endif %}" onclick="applySort('price', 'ns')">
                      Price / 1M <span class="sort-icon">{{ '‚Üì' if (sort_ns_by == 'price' and sort_ns_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_ns_by == 'volume' %}active-sort{% endif %}" onclick="applySort('volume', 'ns')">
                      OR Volume <span class="sort-icon">{{ '‚Üì' if (sort_ns_by == 'volume' and sort_ns_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_ns_by == 'days_in_board' %}active-sort{% endif %}" onclick="applySort('days_in_board', 'ns')">
                      Days in Board <span class="sort-icon">{{ '‚Üì' if (sort_ns_by == 'days_in_board' and sort_ns_order == 'desc') else '‚Üë' }}</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in new_stars[win] %}
                  <tr class="{% if r.rank <= 3 %}top3{% endif %}">
                    <td class="cat-label">{{ r.category }}</td>
                    <td class="col-rank"><span class="rank-num">{{ r.rank }}</span></td>
                    <td class="col-avatar">
                      <div class="lab-avatar-container">
                        {% if r.lab_logo %}
                          <img src="{{ r.lab_logo }}" class="lab-logo" alt="{{ r.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <span class="lab-avatar" data-lab="{{ r.lab }}" {% if r.lab_logo %}style="display:none;"{% endif %}>{{ r.lab[0] }}</span>
                      </div>
                    </td>
                    <td class="col-model">{{ r.model_display }}</td>
                    <td class="col-val">{{ r.elo }}</td>
                    <td class="col-val">{% if r.price_input %}${{ "%.2f"|format(r.price_input) }}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if r.or_volume %}{% if r.or_volume >= 1000000000 %}{{ "%.1f"|format(r.or_volume / 1000000000) }}B{% else %}{{ "%.1f"|format(r.or_volume / 1000000) }}M{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if r.days_in_board %}{{ r.days_in_board|int }} <span style="font-size: 11px; color: var(--text-tertiary);">days</span>{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="8" style="text-align: center; color: var(--text-tertiary); padding: 32px 0;">No new stars detected recently</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </details>
  </section>

  <!-- Leaderboard -->
  <section id="rankings">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> Leaderboard</h2>
        <div class="tabs" onclick="event.preventDefault(); event.stopPropagation();">
          <button class="tab {% if tab == 'general' %}active{% endif %}" data-cat="general" onclick="switchTab('general')">General</button>
          <button class="tab {% if tab == 'coding' %}active{% endif %}" data-cat="coding" onclick="switchTab('coding')">Coding</button>
        </div>
      </summary>
      <div class="section-content">
        <div class="card">
          {% for cat_key in ["general", "coding"] %}
          <div class="tab-panel {% if tab == cat_key %}active{% endif %}" data-section="lb" data-cat="{{ cat_key }}">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="col-rank {% if sort_lb_by == 'rank' %}active-sort{% endif %}" onclick="applySort('rank', 'lb')">
                      Rank <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'rank' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-avatar"></th>
                    <th>Model</th>
                    <th class="col-val {% if sort_lb_by == 'elo' %}active-sort{% endif %}" onclick="applySort('elo', 'lb')">
                      ELO <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'elo' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-delta {% if sort_lb_by == 'delta' %}active-sort{% endif %}" onclick="applySort('delta', 'lb')">
                      7d Œî <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'delta' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_lb_by == 'price' %}active-sort{% endif %}" onclick="applySort('price', 'lb')">
                      Price / 1M <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'price' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_lb_by == 'volume' %}active-sort{% endif %}" onclick="applySort('volume', 'lb')">
                      OR Volume <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'volume' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val {% if sort_lb_by == 'days_in_board' %}active-sort{% endif %}" onclick="applySort('days_in_board', 'lb')">
                      Days in Board <span class="sort-icon">{{ '‚Üì' if (sort_lb_by == 'days_in_board' and sort_lb_order == 'desc') else '‚Üë' }}</span>
                    </th>
                    <th class="col-val">Ctx</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in rankings[cat_key] %}
                  <tr class="{% if r.rank <= 3 %}top3{% endif %}">
                    <td class="col-rank"><span class="rank-num">{{ r.rank }}</span></td>
                    <td class="col-avatar">
                      <div class="lab-avatar-container">
                        {% if r.lab_logo %}
                          <img src="{{ r.lab_logo }}" class="lab-logo" alt="{{ r.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <span class="lab-avatar" data-lab="{{ r.lab }}" {% if r.lab_logo %}style="display:none;"{% endif %}>{{ r.lab[0] }}</span>
                      </div>
                    </td>
                    <td class="col-model">
                      {{ r.model_display }}
                      {% if r.is_new_star %}<span class="tag tag-new">New</span>{% endif %}
                      {% if r.is_riser %}<span class="tag tag-rise">Rising</span>{% endif %}
                    </td>
                    <td class="col-val">{{ r.elo }}</td>
                    <td class="col-delta">
                      {% if r.rank_delta %}
                        <span class="{% if r.rank_delta > 0 %}text-green{% elif r.rank_delta < 0 %}text-red{% else %}na{% endif %}">
                          {{ '‚Üë' if r.rank_delta > 0 else ('‚Üì' if r.rank_delta < 0 else '') }}{{ r.rank_delta|abs if r.rank_delta != 0 else '-' }}
                        </span>
                      {% else %}
                        <span class="na">‚Äî</span>
                      {% endif %}
                    </td>
                    <td class="col-val">{% if r.price_input %}${{ "%.2f"|format(r.price_input) }}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if r.or_volume %}{% if r.or_volume >= 1000000000 %}{{ "%.1f"|format(r.or_volume / 1000000000) }}B{% else %}{{ "%.1f"|format(r.or_volume / 1000000) }}M{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if r.days_in_board %}{{ r.days_in_board|int }} <span style="font-size: 11px; color: var(--text-tertiary);">days</span>{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val" style="font-size: 11px; color: var(--text-tertiary);">{% if r.context_length %}{% if r.context_length >= 1000000 %}{{ (r.context_length//1000000)|string }}M{% else %}{{ (r.context_length//1000)|string }}k{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="9" style="text-align: center; color: var(--text-tertiary); padding: 32px 0;">No rankings available</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Paging -->
        {% if total_pages > 1 %}
        <div class="pagination">
          <a href="/?page={{ page - 1 }}&tab={{ tab }}&sort_lb={{ sort_lb_by }}&order_lb={{ sort_lb_order }}&sort_fr={{ sort_fr_by }}&order_fr={{ sort_fr_order }}&sort_ns={{ sort_ns_by }}&order_ns={{ sort_ns_order }}#rankings" class="btn-page {% if page <= 1 %}disabled{% endif %}">Prev</a>
          {% for p in range(1, total_pages + 1) %}
            {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
              <a href="/?page={{ p }}&tab={{ tab }}&sort_lb={{ sort_lb_by }}&order_lb={{ sort_lb_order }}&sort_fr={{ sort_fr_by }}&order_fr={{ sort_fr_order }}&sort_ns={{ sort_ns_by }}&order_ns={{ sort_ns_order }}#rankings" class="btn-page {% if p == page %}active{% endif %}">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
              <span style="color: var(--text-tertiary); font-size: 14px; margin: 0 4px;">...</span>
            {% endif %}
          {% endfor %}
          <a href="/?page={{ page + 1 }}&tab={{ tab }}&sort_lb={{ sort_lb_by }}&order_lb={{ sort_lb_order }}&sort_fr={{ sort_fr_by }}&order_fr={{ sort_fr_order }}&sort_ns={{ sort_ns_by }}&order_ns={{ sort_ns_order }}#rankings" class="btn-page {% if page >= total_pages %}disabled{% endif %}">Next</a>
        </div>
        {% endif %}
      </div>
    </details>
  </section>

  <!-- Model Picks -->
  <section id="model-picks">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> Model Picks</h2>
      </summary>
      <div class="section-content">
        <div class="picks-grid">
          <!-- Cloud -->
          <div class="card">
            <div class="card-label">‚òÅÔ∏è Cloud / Proprietary</div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width: 110px">Type</th>
                    <th>Model</th>
                    <th>Lab</th>
                    <th class="col-val">ELO</th>
                    <th class="col-val">$/1M</th>
                    <th class="col-val">OR Vol</th>
                    <th class="col-val">Ctx</th>
                  </tr>
                </thead>
                <tbody>
                  {% set cloud_picks = [
                    ("Best Overall",    model_picks.best_cloud,         model_picks.best_cloud_ru),
                    ("Best Value",      model_picks.best_value_cloud,   model_picks.best_value_cloud_ru),
                    ("Best Coding",     model_picks.best_coding_cloud,  model_picks.best_coding_cloud_ru),
                    ("Long Context",    model_picks.best_long_ctx_cloud,model_picks.best_long_ctx_cloud_ru),
                    ("Most Adopted",    model_picks.most_adopted_cloud, model_picks.most_adopted_cloud_ru),
                  ] %}
                  {% for label, m, ru in cloud_picks %}
                  <tr>
                    <td style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.04em;">{{ label }}</td>
                    {% if m %}
                    <td class="col-model" title="{{ m.model_id }}">
                      {{ m.model_display }}
                      {% if ru %}<div style="font-size: 10px; color: var(--text-tertiary); margin-top: 1px;">‚Ü≥ {{ ru.model_display }}</div>{% endif %}
                    </td>
                    <td style="color: var(--text-tertiary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
                      <div class="lab-avatar-container" style="width: 18px; height: 18px;">
                        {% if m.lab_logo %}
                          <img src="{{ m.lab_logo }}" class="lab-logo" style="width: 18px; height: 18px;" alt="{{ m.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <span class="lab-avatar" data-lab="{{ m.lab }}" style="width: 18px; height: 18px; font-size: 9px; {% if m.lab_logo %}display:none;{% endif %}">{{ m.lab[0] }}</span>
                      </div>
                      {{ m.lab }}
                    </td>
                    <td class="col-val">{{ m.elo }}</td>
                    <td class="col-val">{% if m.price_input %}${{ "%.2f"|format(m.price_input) }}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if m.or_volume %}{% if m.or_volume >= 1000000000 %}{{ "%.1f"|format(m.or_volume/1000000000) }}B{% else %}{{ "%.1f"|format(m.or_volume/1000000) }}M{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if m.context_length %}{% if m.context_length >= 1000000 %}{{ (m.context_length//1000000)|string }}M{% else %}{{ (m.context_length//1000)|string }}k{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    {% else %}
                    <td colspan="6" class="na">‚Äî</td>
                    {% endif %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <!-- Open Source -->
          <div class="card">
            <div class="card-label">üîì Open Source</div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width: 110px">Type</th>
                    <th>Model</th>
                    <th>Lab</th>
                    <th class="col-val">ELO</th>
                    <th class="col-val">$/1M</th>
                    <th class="col-val">OR Vol</th>
                    <th class="col-val">Ctx</th>
                  </tr>
                </thead>
                <tbody>
                  {% set oss_picks = [
                    ("Best Overall",    model_picks.best_oss,         model_picks.best_oss_ru),
                    ("Best Value",      model_picks.best_value_oss,   model_picks.best_value_oss_ru),
                    ("Best Coding",     model_picks.best_coding_oss,  model_picks.best_coding_oss_ru),
                    ("Long Context",    model_picks.best_long_ctx_oss,model_picks.best_long_ctx_oss_ru),
                    ("Most Adopted",    model_picks.most_adopted_oss, model_picks.most_adopted_oss_ru),
                  ] %}
                  {% for label, m, ru in oss_picks %}
                  <tr>
                    <td style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.04em;">{{ label }}</td>
                    {% if m %}
                    <td class="col-model" title="{{ m.model_id }}">
                      {{ m.model_display }}
                      {% if ru %}<div style="font-size: 10px; color: var(--text-tertiary); margin-top: 1px;">‚Ü≥ {{ ru.model_display }}</div>{% endif %}
                    </td>
                    <td style="color: var(--text-tertiary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
                      <div class="lab-avatar-container" style="width: 18px; height: 18px;">
                        {% if m.lab_logo %}
                          <img src="{{ m.lab_logo }}" class="lab-logo" style="width: 18px; height: 18px;" alt="{{ m.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <span class="lab-avatar" data-lab="{{ m.lab }}" style="width: 18px; height: 18px; font-size: 9px; {% if m.lab_logo %}display:none;{% endif %}">{{ m.lab[0] }}</span>
                      </div>
                      {{ m.lab }}
                    </td>
                    <td class="col-val">{{ m.elo }}</td>
                    <td class="col-val">{% if m.price_input %}${{ "%.2f"|format(m.price_input) }}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if m.or_volume %}{% if m.or_volume >= 1000000000 %}{{ "%.1f"|format(m.or_volume/1000000000) }}B{% else %}{{ "%.1f"|format(m.or_volume/1000000) }}M{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    <td class="col-val">{% if m.context_length %}{% if m.context_length >= 1000000 %}{{ (m.context_length//1000000)|string }}M{% else %}{{ (m.context_length//1000)|string }}k{% endif %}{% else %}<span class="na">‚Äî</span>{% endif %}</td>
                    {% else %}
                    <td colspan="6" class="na">‚Äî</td>
                    {% endif %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </details>
  </section>

  <!-- Investment Watch -->
  <section id="investment-watch">
    <details open>
      <summary class="section-header">
        <h2><span class="fold-icon">‚ñº</span> Investment Watch</h2>
      </summary>
      <div class="section-content">
        <div class="card">
          <div class="table-container">
            <table class="scorecard-table">
              <thead>
                <tr>
                  <th>Lab</th>
                  <th class="col-val">Score</th>
                  <th class="col-val">Mkt Share</th>
                  <th class="col-val">Rev/wk</th>
                  <th class="col-val">Top-10 G/C</th>
                  <th class="col-val">Top-30 G/C</th>
                  <th class="col-val">OSS/Prop</th>
                  <th class="col-val">Risers+Stars</th>
                  <th>Top Model</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in company_scorecard %}
                <tr>
                  <td class="col-model" style="display: flex; align-items: center; gap: 8px;">
                    <div class="lab-avatar-container">
                      {% if entry.lab_logo %}
                        <img src="{{ entry.lab_logo }}" class="lab-logo" alt="{{ entry.lab }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                      {% endif %}
                      <span class="lab-avatar" data-lab="{{ entry.lab }}" {% if entry.lab_logo %}style="display:none;"{% endif %}>{{ entry.lab[0] }}</span>
                    </div>
                    {{ entry.lab }}
                    {% if entry.category_leader %}<span class="tag tag-new" style="margin-left:4px;" title="Rank-1 in at least one category">‚òÖ</span>{% endif %}
                  </td>
                  <td class="col-val"><span class="score-pill">{{ entry.investment_score }}</span></td>
                  <td class="col-val">
                    {% if entry.market_share_pct %}
                    <span title="{{ '%.1f'|format(entry.market_share_pct) }}%">
                      {{ '%.1f'|format(entry.market_share_pct) }}%
                      <div style="height:3px;width:{{ [entry.market_share_pct*2, 60]|min|int }}px;background:var(--accent);border-radius:2px;margin-top:2px;opacity:0.6;"></div>
                    </span>
                    {% else %}<span class="na">‚Äî</span>{% endif %}
                  </td>
                  <td class="col-val">
                    {% if entry.revenue_proxy %}
                      {% if entry.revenue_proxy >= 1000000 %}${{ "%.1f"|format(entry.revenue_proxy/1000000) }}M
                      {% elif entry.revenue_proxy >= 1000 %}${{ "%.0f"|format(entry.revenue_proxy/1000) }}K
                      {% else %}${{ "%.0f"|format(entry.revenue_proxy) }}
                      {% endif %}
                    {% else %}<span class="na">‚Äî</span>{% endif %}
                  </td>
                  <td class="col-val">{{ entry.top10_general }}/{{ entry.top10_coding }}</td>
                  <td class="col-val">{{ entry.top30_general }}/{{ entry.top30_coding }}</td>
                  <td class="col-val" style="font-size: 11px; color: var(--text-secondary);">{{ entry.oss_count }}&#x1F513;/{{ entry.proprietary_count }}&#x1F510;</td>
                  <td class="col-val">{{ (entry.fast_risers + entry.new_stars) or '‚Äî' }}</td>
                  <td style="color: var(--text-secondary); max-width: 180px; overflow: hidden; text-overflow: ellipsis; font-size: 12px;" title="{{ entry.top_model }}">{{ entry.top_model }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="9" style="text-align: center; color: var(--text-tertiary); padding: 32px 0;">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </details>
  </section>

</main>

<script>
const LAB_COLORS = {
  'Anthropic':  '#e07b39',
  'OpenAI':     '#10a37f',
  'Google':     '#4285f4',
  'xAI':        '#888fa8',
  'NVIDIA':     '#76b900',
  'Meta':       '#1877f2',
  'Mistral':    '#f97316',
  'DeepSeek':   '#536dfe',
  'Alibaba':    '#ff6900',
  'Microsoft':  '#00a4ef',
  'Cohere':     '#d4432c',
  'Moonshot':   '#7c3aed',
  'Zhipu':      '#cc0000',
  'IBM':        '#054ada',
  'AI2':        '#6d28d9',
  'AI21 Labs':  '#f59e0b',
  '01.AI':      '#64748b',
  'ByteDance':  '#fe2c55',
};

// Expose the current states from jinja to JS
const currentSort = {
  lb: { by: '{{ sort_lb_by }}', order: '{{ sort_lb_order }}' },
  fr: { by: '{{ sort_fr_by }}', order: '{{ sort_fr_order }}' },
  ns: { by: '{{ sort_ns_by }}', order: '{{ sort_ns_order }}' }
};

let frWin = '7d';
let nsWin = '7d';
let currentCat = '{{ tab }}';

function applySort(field, section) {
  let order = 'asc';
  if (currentSort[section].by === field) {
    order = (currentSort[section].order === 'asc') ? 'desc' : 'asc';
  } else {
    if (['elo', 'delta', 'days_in_board', 'volume'].includes(field)) order = 'desc';
  }

  const url = new URL(window.location);

  // Set specific parameters based on section
  url.searchParams.set(`sort_${section}`, field);
  url.searchParams.set(`order_${section}`, order);

  // Reset pagination if Leaderboard sorting changed
  if (section === 'lb') {
    url.searchParams.set('page', '1');
    window.location.href = url.toString() + '#rankings';
  } else {
    // Maintain scroll position roughly
    window.location.href = url.toString();
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.lab-avatar[data-lab]').forEach(el => {
    const color = LAB_COLORS[el.dataset.lab] || '#565f89';
    el.style.background = color;
  });

  const initialDataEl = document.getElementById('initial-insights-data');
  if (initialDataEl) {
    try {
      const insightsText = JSON.parse(initialDataEl.textContent);
      const textEl = document.getElementById('insights-text');
      textEl.innerHTML = marked.parse(insightsText);
      textEl.className = 'insights-body';
    } catch (e) {
      console.error("Failed to parse initial insights:", e);
    }
  } else if (!{{ 'true' if ai_insights else 'false' }}) {
    refreshInsights();
  }
});

async function refreshInsights(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const btn = document.getElementById('insights-btn');
  const textEl = document.getElementById('insights-text');
  btn.disabled = true;
  btn.textContent = 'Generating‚Ä¶';
  textEl.textContent = 'Running Claude analysis, please wait‚Ä¶';
  textEl.className = 'insights-placeholder';
  try {
    const resp = await fetch('/ai-insights', { method: 'POST' });
    const data = await resp.json();
    if (data.status === 'ok') {
      textEl.innerHTML = marked.parse(data.text);
      textEl.className = 'insights-body';
    } else {
      textEl.textContent = 'Error: ' + data.text;
    }
  } catch (e) {
    textEl.textContent = 'Request failed: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Refresh';
  }
}

function switchTab(cat) {
  currentCat = cat;
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab[data-cat]').forEach(t => t.classList.remove('active'));

  // Activate LB panels for this cat
  document.querySelectorAll(`.tab-panel[data-section="lb"][data-cat="${cat}"]`).forEach(p => p.classList.add('active'));
  // Activate FR panels for this cat + current window
  document.querySelectorAll(`.tab-panel[data-section="fr"][data-cat="${cat}"][data-win="${frWin}"]`).forEach(p => p.classList.add('active'));
  // Re-activate current NS panel
  document.querySelectorAll(`.tab-panel[data-section="ns"][data-win="${nsWin}"]`).forEach(p => p.classList.add('active'));

  document.querySelectorAll(`.tab[data-cat="${cat}"]`).forEach(t => t.classList.add('active'));

  const url = new URL(window.location);
  url.searchParams.set('tab', cat);
  window.history.pushState({}, '', url);

  document.querySelectorAll('.pagination .btn-page').forEach(link => {
    const lUrl = new URL(link.href, window.location.origin);
    lUrl.searchParams.set('tab', cat);
    link.href = lUrl.toString() + '#rankings';
  });
}

function switchFrWin(win) {
  frWin = win;
  document.querySelectorAll('.tab-panel[data-section="fr"]').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#fr-win .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll(`.tab-panel[data-section="fr"][data-cat="${currentCat}"][data-win="${win}"]`).forEach(p => p.classList.add('active'));
  document.querySelectorAll(`#fr-win .tab[data-win="${win}"]`).forEach(t => t.classList.add('active'));
}

function switchNsWin(win) {
  nsWin = win;
  document.querySelectorAll('.tab-panel[data-section="ns"]').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#ns-win .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll(`.tab-panel[data-section="ns"][data-win="${win}"]`).forEach(p => p.classList.add('active'));
  document.querySelectorAll(`#ns-win .tab[data-win="${win}"]`).forEach(t => t.classList.add('active'));
}
</script>

</body>
</html>